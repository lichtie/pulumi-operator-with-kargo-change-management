# Cluster Setup

This Pulumi project sets up a Kubernetes cluster with the following components:
- Pulumi Kubernetes Operator (v2.0.0)
- cert-manager (v1.19.0)
- ArgoCD (stable)
- Argo Rollouts (latest)
- Kargo (via Helm)

## Prerequisites

- Pulumi CLI installed
- kubectl configured
- htpasswd utility (for generating Kargo password hash)
- openssl (for generating secrets)

## Setup

1. **Configure the cluster stack reference:**
   ```bash
   pulumi config set clusterStack <your-cluster-stack>
   ```

2. **Set AWS credentials (already configured in Pulumi.dev.yaml):**
   ```bash
   pulumi config set --secret awsAccessKeyId <your-access-key-id>
   pulumi config set --secret awsSecretAccessKey <your-secret-access-key>
   ```

3. **Set Pulumi API token (already configured in Pulumi.dev.yaml):**
   ```bash
   pulumi config set --secret pulumiApiToken <your-token>
   ```

4. **Generate and configure Kargo admin credentials:**
   ```bash
   ./generate-kargo-secrets.sh
   ```

   This script will:
   - Generate a random 32-character password
   - Hash the password using bcrypt
   - Generate a random 32-character token signing key
   - Configure both secrets in Pulumi
   - Display the plaintext password (save it securely!)

   Alternatively, you can manually generate and set the secrets:
   ```bash
   pass=$(openssl rand -base64 48 | tr -d "=+/" | head -c 32)
   echo "Password: $pass"
   hashed_pass=$(htpasswd -bnBC 10 "" $pass | tr -d ':\n')
   signing_key=$(openssl rand -base64 48 | tr -d "=+/" | head -c 32)

   pulumi config set --secret kargoAdminPasswordHash "$hashed_pass"
   pulumi config set --secret kargoTokenSigningKey "$signing_key"
   ```

## Deployment

Deploy all components:
```bash
pulumi up
```

This will install:
- **Pulumi Kubernetes Operator**: Creates the pulumi-kubernetes-operator namespace and installs the operator
- **cert-manager**: Creates the cert-manager namespace and installs cert-manager with CRDs
- **ArgoCD**: Creates the argocd namespace and installs ArgoCD
- **Argo Rollouts**: Creates the argo-rollouts namespace and installs Argo Rollouts
- **Kargo**: Creates the kargo namespace and installs Kargo with admin credentials

## Accessing Services

### ArgoCD
Get the initial admin password:
```bash
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
```

Port-forward to access the UI:
```bash
kubectl port-forward svc/argocd-server -n argocd 8080:443
```

Then access at: https://localhost:8080

### Kargo
Use the password generated by `generate-kargo-secrets.sh` to log in as admin.

Port-forward to access the UI:
```bash
kubectl port-forward svc/kargo-api -n kargo 8081:80
```

## Cleanup

Remove all resources:
```bash
pulumi destroy
```

## Installation Equivalents

This Pulumi setup is equivalent to running:

```bash
# Pulumi Kubernetes Operator
helm install --create-namespace -n pulumi-kubernetes-operator pulumi-kubernetes-operator \
  oci://ghcr.io/pulumi/helm-charts/pulumi-kubernetes-operator --version 2.0.0

# cert-manager
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.19.0/cert-manager.yaml

# ArgoCD
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# Argo Rollouts
kubectl create namespace argo-rollouts
kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml

# Kargo
helm install kargo \
  oci://ghcr.io/akuity/kargo-charts/kargo \
  --namespace kargo \
  --create-namespace \
  --set api.adminAccount.passwordHash=$hashed_pass \
  --set api.adminAccount.tokenSigningKey=$signing_key \
  --wait
```
