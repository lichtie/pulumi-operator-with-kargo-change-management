apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: qapreview
  namespace: kargo-managed-stack
  annotations:
    kargo.akuity.io/color: violet
spec:
  # Subscribe directly to the Warehouse for automatic deployments
  requestedFreight:
    - origin:
        kind: Warehouse
        name: security-scan-repo
      sources:
        direct: false
        availabilityStrategy: All
        stages:
          - approvalgateqa
          - approvalgateqasec

  # Update stacks/qapreview.yaml with the latest commit from freight
  promotionTemplate:
    spec:
      steps:
        - uses: git-clone
          config:
            repoURL: https://github.com/lichtie/kargo-manifests
            checkout:
              - branch: main
                path: ./manifests
        - uses: yaml-update
          config:
            path: ./manifests/stacks/qapreview.yaml
            updates:
              - key: spec.commit
                value: ${{ commitFrom("https://github.com/lichtie/security-scanner").ID }}
        - uses: git-commit
          as: commit
          config:
            path: ./manifests
            message: 'Update qapreview to ${{ commitFrom("https://github.com/lichtie/security-scanner").ID }}'
        - uses: git-push
          config:
            path: ./manifests
            targetBranch: main

  verification:
    analysisTemplates:
      - name: pulumi-stack-preview-success
    args:
      - name: commit-id
        value: ${{ commitFrom("https://github.com/lichtie/security-scanner").ID }}
      - name: stackName
        value: qa
